# webpage_generator.py

"""
Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Îã§ÌÅ¨Î™®Îìú + Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏõπÌéòÏù¥ÏßÄÎ°ú ÏÉùÏÑ±
- Îã§ÌÅ¨ ÌÖåÎßà ÎîîÏûêÏù∏
- ÌÅ¥Î¶≠ Í∞ÄÎä•Ìïú ÏöîÏÜåÎì§
- Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
- Î∞òÏùëÌòï ÎîîÏûêÏù∏
"""

import streamlit as st
from datetime import datetime
from typing import Dict, List

def process_analysis_content(result: str) -> str:
    """Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Îçî ÏùΩÍ∏∞ ÏâΩÍ≤å Íµ¨Ï°∞Ìôî"""
    paragraphs = result.split('\n\n')
    formatted_paragraphs = []
    
    for para in paragraphs:
        if para.strip():
            if para.startswith('#') or para.startswith('##'):
                formatted_paragraphs.append(f'<h3 class="content-subtitle">{para.strip("# ")}</h3>')
            elif para.startswith('-') or para.startswith('‚Ä¢'):
                items = para.split('\n')
                list_html = '<ul class="content-list">'
                for item in items:
                    if item.strip():
                        list_html += f'<li>{item.strip("- ‚Ä¢")}</li>'
                list_html += '</ul>'
                formatted_paragraphs.append(list_html)
            else:
                formatted_paragraphs.append(f'<p class="content-text">{para}</p>')
    
    return '\n'.join(formatted_paragraphs)

def add_visual_elements(analysis_results: List[Dict]) -> List[Dict]:
    """Î∂ÑÏÑù Í≤∞Í≥ºÏóê ÏãúÍ∞ÅÏ†Å ÏöîÏÜå Ï∂îÍ∞Ä"""
    enhanced_results = []
    
    for result in analysis_results:
        step_type = result.get('step', '').lower()
        
        if 'ÏöîÍµ¨ÏÇ¨Ìï≠' in step_type:
            icon = "üéØ"
            color = "#00d4ff"
            category = "requirements"
        elif 'Ï∂îÎ°†' in step_type or 'reasoning' in step_type:
            icon = "üß†"
            color = "#ff6b6b"
            category = "reasoning"
        elif 'ÏÇ¨Î°Ä' in step_type or 'comparison' in step_type:
            icon = "üìö"
            color = "#4ecdc4"
            category = "comparison"
        elif 'Ï†ÑÎûµ' in step_type or 'strategy' in step_type:
            icon = "ÔøΩÔøΩ"
            color = "#45b7d1"
            category = "strategy"
        else:
            icon = "ÔøΩÔøΩ"
            color = "#96ceb4"
            category = "analysis"
        
        enhanced_result = result.copy()
        enhanced_result['icon'] = icon
        enhanced_result['color'] = color
        enhanced_result['category'] = category
        enhanced_results.append(enhanced_result)
    
    return enhanced_results

def generate_dark_interactive_webpage(analysis_results: List[Dict], project_info: Dict) -> str:
    """Îã§ÌÅ¨Î™®Îìú + Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏõπÌéòÏù¥ÏßÄ HTML ÏÉùÏÑ±"""
    
    # ÏãúÍ∞ÅÏ†Å ÏöîÏÜå Ï∂îÍ∞Ä
    enhanced_results = add_visual_elements(analysis_results)
    
    html_template = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{project_info.get('project_name', 'ÌîÑÎ°úÏ†ùÌä∏')} Î∂ÑÏÑù Î≥¥Í≥†ÏÑú</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        :root {{
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #2a2a2a;
            --bg-hover: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --accent-blue: #00d4ff;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ff6b6b;
            --accent-yellow: #fbbf24;
            --border-color: #404040;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.4);
            --shadow-heavy: 0 15px 35px rgba(0, 0, 0, 0.5);
        }}
        
        body {{
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }}
        
        .container {{
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }}
        
        /* Ìó§Îçî Ïä§ÌÉÄÏùº */
        .header {{
            text-align: center;
            margin-bottom: 60px;
            padding: 60px 40px;
            background: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }}
        
        .header::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(0, 212, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }}
        
        @keyframes shimmer {{
            0% {{ transform: translateX(-100%); }}
            100% {{ transform: translateX(100%); }}
        }}
        
        .header h1 {{
            font-size: 3.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }}
        
        .header p {{
            font-size: 1.3rem;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }}
        
        /* ÌÜµÍ≥Ñ Ïπ¥Îìú Í∑∏Î¶¨Îìú */
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }}
        
        .stat-card {{
            background: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }}
        
        .stat-card::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }}
        
        .stat-card:hover {{
            transform: translateY(-10px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            background: rgba(58, 58, 58, 0.9);
        }}
        
        .stat-card:hover::before {{
            transform: scaleX(1);
        }}
        
        .stat-icon {{
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
            transition: transform 0.3s ease;
        }}
        
        .stat-card:hover .stat-icon {{
            transform: scale(1.1);
        }}
        
        .stat-title {{
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }}
        
        .stat-value {{
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }}
        
        /* Î∂ÑÏÑù ÏÑπÏÖò */
        .analysis-section {{
            background: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 50px 40px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }}
        
        .section-header {{
            text-align: center;
            margin-bottom: 50px;
        }}
        
        .section-title {{
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }}
        
        .section-subtitle {{
            color: var(--text-secondary);
            font-size: 1.1rem;
        }}
        
        /* ÌïÑÌÑ∞ Î≤ÑÌäº */
        .filter-buttons {{
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }}
        
        .filter-btn {{
            background: rgba(58, 58, 58, 0.8);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }}
        
        .filter-btn:hover, .filter-btn.active {{
            background: var(--accent-blue);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }}
        
        /* Í≤∞Í≥º Ïπ¥Îìú Í∑∏Î¶¨Îìú */
        .result-grid {{
            display: grid;
            gap: 30px;
        }}
        
        .result-card {{
            background: rgba(58, 58, 58, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border-left: 5px solid var(--accent-blue);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }}
        
        .result-card::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(0, 212, 255, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }}
        
        .result-card:hover {{
            transform: translateX(10px) scale(1.02);
            box-shadow: var(--shadow-heavy);
            background: rgba(74, 74, 74, 0.9);
        }}
        
        .result-card:hover::before {{
            opacity: 1;
        }}
        
        .result-header {{
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }}
        
        .result-icon {{
            font-size: 2.5rem;
            margin-right: 20px;
            transition: transform 0.3s ease;
        }}
        
        .result-card:hover .result-icon {{
            transform: rotate(10deg) scale(1.1);
        }}
        
        .result-title {{
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }}
        
        .result-content {{
            font-size: 1.1rem;
            line-height: 1.7;
            color: var(--text-secondary);
            background: rgba(42, 42, 42, 0.8);
            padding: 25px;
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }}
        
        .result-card.expanded .result-content {{
            max-height: none;
        }}
        
        .expand-btn {{
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--accent-blue);
            color: var(--text-primary);
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            z-index: 2;
        }}
        
        .expand-btn:hover {{
            background: var(--accent-purple);
            transform: scale(1.05);
        }}
        
        /* ÏΩòÌÖêÏ∏† Ïä§ÌÉÄÏùº */
        .content-subtitle {{
            color: var(--accent-blue);
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }}
        
        .content-text {{
            margin: 10px 0;
            color: var(--text-secondary);
        }}
        
        .content-list {{
            margin: 10px 0;
            padding-left: 20px;
            color: var(--text-secondary);
        }}
        
        .content-list li {{
            margin: 5px 0;
        }}
        
        /* Ìë∏ÌÑ∞ */
        .footer {{
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            margin-top: 60px;
            border-top: 1px solid var(--border-color);
        }}
        
        .footer p {{
            margin: 5px 0;
        }}
        
        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {{
            .header h1 {{
                font-size: 2.5rem;
            }}
            .stat-card {{
                padding: 30px 20px;
            }}
            .analysis-section {{
                padding: 30px 20px;
            }}
            .filter-buttons {{
                flex-direction: column;
                align-items: center;
            }}
        }}
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes fadeInUp {{
            from {{
                opacity: 0;
                transform: translateY(30px);
            }}
            to {{
                opacity: 1;
                transform: translateY(0);
            }}
        }}
        
        .result-card {{
            animation: fadeInUp 0.6s ease forwards;
        }}
        
        .result-card:nth-child(1) {{ animation-delay: 0.1s; }}
        .result-card:nth-child(2) {{ animation-delay: 0.2s; }}
        .result-card:nth-child(3) {{ animation-delay: 0.3s; }}
        .result-card:nth-child(4) {{ animation-delay: 0.4s; }}
        .result-card:nth-child(5) {{ animation-delay: 0.5s; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåô {project_info.get('project_name', 'ÌîÑÎ°úÏ†ùÌä∏')}</h1>
            <p>AI-Driven Architecture Analysis Report</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card" onclick="showDetails('project')">
                <span class="stat-icon">üè¢</span>
                <div class="stat-title">ÌîÑÎ°úÏ†ùÌä∏Î™Ö</div>
                <div class="stat-value">{project_info.get('project_name', 'N/A')}</div>
            </div>
            <div class="stat-card" onclick="showDetails('building')">
                <span class="stat-icon">üèóÔ∏è</span>
                <div class="stat-title">Í±¥Î¨ºÏö©ÎèÑ</div>
                <div class="stat-value">{project_info.get('building_type', 'N/A')}</div>
            </div>
            <div class="stat-card" onclick="showDetails('location')">
                <span class="stat-icon">üìç</span>
                <div class="stat-title">ÎåÄÏßÄÏúÑÏπò</div>
                <div class="stat-value">{project_info.get('site_location', 'N/A')}</div>
            </div>
            <div class="stat-card" onclick="showDetails('owner')">
                <span class="stat-icon">üë•</span>
                <div class="stat-title">Í±¥Ï∂ïÏ£º</div>
                <div class="stat-value">{project_info.get('owner', 'N/A')}</div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="section-header">
                <h2 class="section-title">üìã Î∂ÑÏÑù Í≤∞Í≥º</h2>
                <p class="section-subtitle">ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterResults('all')">Ï†ÑÏ≤¥</button>
                <button class="filter-btn" onclick="filterResults('requirements')">ÏöîÍµ¨ÏÇ¨Ìï≠</button>
                <button class="filter-btn" onclick="filterResults('reasoning')">Ï∂îÎ°†</button>
                <button class="filter-btn" onclick="filterResults('comparison')">ÏÇ¨Î°Ä</button>
                <button class="filter-btn" onclick="filterResults('strategy')">Ï†ÑÎûµ</button>
            </div>
            
            <div class="result-grid">
"""
    
    # Î∂ÑÏÑù Í≤∞Í≥º Ïπ¥ÎìúÎì§ ÏÉùÏÑ±
    for i, result in enumerate(enhanced_results, 1):
        processed_content = process_analysis_content(result.get('result', 'Î∂ÑÏÑù Í≤∞Í≥º ÏóÜÏùå'))
        
        card_html = f"""
                <div class="result-card" data-category="{result.get('category', 'analysis')}" onclick="toggleCard(this)">
                    <div class="result-header">
                        <span class="result-icon" style="color: {result.get('color', '#00d4ff')}">{result.get('icon', 'üìä')}</span>
                        <div class="result-title">{result.get('step', f'Î∂ÑÏÑù Îã®Í≥Ñ {i}')}</div>
                    </div>
                    <div class="result-content">
                        {processed_content}
                    </div>
                    <button class="expand-btn" onclick="event.stopPropagation(); toggleExpand(this)">ÎçîÎ≥¥Í∏∞</button>
                </div>
"""
        html_template += card_html
    
    html_template += f"""
            </div>
        </div>
        
        <div class="footer">
            <p>ÏÉùÏÑ±Ïùº: {datetime.now().strftime("%YÎÖÑ %mÏõî %dÏùº %H:%M")}</p>
            <p>ArchInsight - AI-driven Project Insight & Workflow</p>
        </div>
    </div>
    
    <script>
        // Ïπ¥Îìú ÌôïÏû•/Ï∂ïÏÜå
        function toggleExpand(btn) {{
            const card = btn.closest('.result-card');
            card.classList.toggle('expanded');
            btn.textContent = card.classList.contains('expanded') ? 'Ï†ëÍ∏∞' : 'ÎçîÎ≥¥Í∏∞';
        }}
        
        // Ïπ¥Îìú ÌÅ¥Î¶≠ Ìö®Í≥º
        function toggleCard(card) {{
            card.style.transform = 'scale(0.98)';
            setTimeout(() => {{
                card.style.transform = '';
            }}, 150);
        }}
        
        // ÌïÑÌÑ∞ÎßÅ
        function filterResults(category) {{
            const cards = document.querySelectorAll('.result-card');
            const buttons = document.querySelectorAll('.filter-btn');
            
            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Ïπ¥Îìú ÌïÑÌÑ∞ÎßÅ
            cards.forEach(card => {{
                if (category === 'all' || card.dataset.category === category) {{
                    card.style.display = 'block';
                    card.style.animation = 'fadeInUp 0.6s ease forwards';
                }} else {{
                    card.style.display = 'none';
                }}
            }});
        }}
        
        // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
        function showDetails(type) {{
            const details = {{
                project: 'ÌîÑÎ°úÏ†ùÌä∏ Í∏∞Î≥∏ Ï†ïÎ≥¥',
                building: 'Í±¥Î¨º Ïö©ÎèÑ Î∞è Í∑úÎ™®',
                location: 'ÎåÄÏßÄ ÏúÑÏπò Î∞è ÌôòÍ≤Ω',
                owner: 'Í±¥Ï∂ïÏ£º Ï†ïÎ≥¥'
            }};
            
            alert(details[type] + '\\n\\nÎçî ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥Îäî PDF Î≥¥Í≥†ÏÑúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        }}
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïï†ÎãàÎ©îÏù¥ÏÖò
        document.addEventListener('DOMContentLoaded', function() {{
            const cards = document.querySelectorAll('.result-card');
            cards.forEach((card, index) => {{
                card.style.animationDelay = `${{(index + 1) * 0.1}}s`;
            }});
        }});
    </script>
</body>
</html>
"""
    
    return html_template

def generate_card_webpage(analysis_results: List[Dict], project_info: Dict) -> str:
    """Í∏∞Ï°¥ Ìï®Ïàò Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú ÎûòÌçº"""
    return generate_dark_interactive_webpage(analysis_results, project_info)

def create_webpage_download_button(analysis_results: List[Dict], project_info: Dict, show_warning: bool = True):
    """ÏõπÌéòÏù¥ÏßÄ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÏÉùÏÑ±"""
    
    if not analysis_results:
        if show_warning:
            st.warning("ÏÉùÏÑ±Îêú Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.")
        return
    
    # HTML ÏÉùÏÑ±
    html_content = generate_dark_interactive_webpage(analysis_results, project_info)
    
    # Îã§Ïö¥Î°úÎìú Î≤ÑÌäº
    st.download_button(
        label="üåô Îã§ÌÅ¨Î™®Îìú Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏõπÌéòÏù¥ÏßÄ Îã§Ïö¥Î°úÎìú",
        data=html_content,
        file_name=f"{project_info.get('project_name', 'Î∂ÑÏÑùÎ≥¥Í≥†ÏÑú')}_Îã§ÌÅ¨Î™®Îìú_ÏõπÌéòÏù¥ÏßÄ.html",
        mime="text/html",
        help="Îã§ÌÅ¨Î™®Îìú + Ïù∏ÌÑ∞ÎûôÌã∞Î∏å ÏöîÏÜåÍ∞Ä Ìè¨Ìï®Îêú ÌòÑÎåÄÏ†ÅÏù∏ ÏõπÌéòÏù¥ÏßÄÎ•º Îã§Ïö¥Î°úÎìúÌï©ÎãàÎã§.",
        key=f"dark_webpage_download_{project_info.get('project_name', 'default')}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    )
    
    # ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
    st.markdown("### üåô Îã§ÌÅ¨Î™®Îìú Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞")
    st.components.v1.html(html_content, height=800, scrolling=True) 